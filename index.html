<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Talisman Evasion Calculator</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;line-height:1.4}
  body{background:#f6f8fb;color:#0b1220;padding:28px;display:flex;justify-content:center}
  .card{background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(11,18,32,0.08);max-width:900px;width:100%;padding:22px}
  h1{margin:0 0 8px;font-size:22px}
  p.lead{margin:0 0 18px;color:#475569}
  table{width:100%;border-collapse:collapse;margin-bottom:10px}
  th,td{padding:8px 10px;text-align:left}
  th{font-size:13px;color:#334155}
  input[type="number"], select{width:100%;box-sizing:border-box;padding:8px;border:1px solid #e6e9ef;border-radius:8px;}
  button{cursor:pointer;border:0;padding:8px 10px;border-radius:8px;background:#0ea5a4;color:white}
  button.ghost{background:#eef2ff;color:#3730a3}
  button.danger{background:#ef4444}
  .row-actions{display:flex;gap:8px}
  .results{background:#f8fafc;border-radius:8px;padding:12px;margin-top:12px;border:1px dashed #e6eef6}
  pre{background:#0b1220;color:#e6eef6;padding:12px;border-radius:8px;overflow:auto}
  .foot{margin-top:12px;color:#64748b;font-size:13px}
</style>
</head>
<body>
<main class="card">
  <h1>Talisman Evasion Stack Calculator</h1>
  <p class="lead">Uses formula: <code>1 - ((1 - evasion%) ^ count)</code> for each rarity, then multiplies remaining hit chances between rarities.</p>

  <table>
    <thead>
      <tr><th>Rarity</th><th>Evasion %</th><th>Count</th><th>Actions</th></tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
    <button id="addRow">➕ Add</button>
    <button id="example" class="ghost">Use example (Mythic ×4)</button>
    <button id="clear" class="danger">Clear</button>
  </div>

  <button id="calculate">Calculate</button>

  <div id="output" class="results" style="display:none">
    <div id="summary"></div>
    <pre id="steps"></pre>
  </div>

  <p class="foot">
    Formula: <b>1 - ((1 - E)^N)</b> per rarity.  
    For mixed rarities, total hit chance = product of all (1 - E_total_rarity).  
    Final evasion = 1 - total_hit.
  </p>
</main>

<script>
(() => {
  const rarityValues = {
    "Common": 3,
    "Unusual": 6,
    "Rare": 9,
    "Epic": 12,
    "Legendary": 15,
    "Mythic": 18,
    "Ultra": 21,
    "Super": 24,
    "Unique": 27
  };

  const rows = document.getElementById("rows");
  const addBtn = document.getElementById("addRow");
  const exampleBtn = document.getElementById("example");
  const clearBtn = document.getElementById("clear");
  const calcBtn = document.getElementById("calculate");
  const output = document.getElementById("output");
  const summary = document.getElementById("summary");
  const steps = document.getElementById("steps");

  function createRow(rarity = "Common", count = 1) {
    const tr = document.createElement("tr");
    const opts = Object.entries(rarityValues)
      .map(([r, val]) => `<option value="${r}" ${r===rarity?"selected":""}>${r} (+${val}%)</option>`)
      .join("");
    tr.innerHTML = `
      <td><select class="rarity">${opts}</select></td>
      <td><input type="number" class="evasion" min="0" max="100" value="${rarityValues[rarity]}" step="0.01"></td>
      <td><input type="number" class="count" min="1" value="${count}"></td>
      <td><button class="remove ghost">Remove</button></td>
    `;
    rows.appendChild(tr);

    tr.querySelector(".remove").addEventListener("click", ()=>tr.remove());
    tr.querySelector(".rarity").addEventListener("change", e=>{
      tr.querySelector(".evasion").value = rarityValues[e.target.value];
    });
  }

  createRow("Mythic",4);

  addBtn.onclick = ()=>createRow();
  exampleBtn.onclick = ()=>{
    rows.innerHTML="";
    createRow("Mythic",4);
  };
  clearBtn.onclick = ()=>{
    rows.innerHTML="";
    output.style.display="none";
  };

  calcBtn.onclick = ()=>{
    const data = Array.from(rows.querySelectorAll("tr")).map(r=>{
      return {
        rarity: r.querySelector(".rarity").value,
        ev: parseFloat(r.querySelector(".evasion").value)/100,
        count: parseInt(r.querySelector(".count").value)
      };
    }).filter(x=>x.count>0);

    if(!data.length) return alert("Add at least one talisman.");

    let totalHitChance = 1;
    const logs = [];

    for(const t of data){
      const indivEvasion = 1 - Math.pow(1 - t.ev, t.count);  // ← your formula
      const indivHit = 1 - indivEvasion;
      logs.push(`${t.rarity}: 1 - ((1 - ${t.ev.toFixed(4)}) ^ ${t.count}) = ${(indivEvasion*100).toFixed(3)}%`);
      totalHitChance *= indivHit;
    }

    const totalEvasion = 1 - totalHitChance;

    summary.innerHTML = `<strong>Total Evasion:</strong> ${(totalEvasion*100).toFixed(3)}%<br>
                         <strong>Total Hit Chance:</strong> ${(totalHitChance*100).toFixed(3)}%`;
    steps.textContent = logs.join("\n");
    output.style.display="block";
  };
})();
</script>
</body>
</html>
